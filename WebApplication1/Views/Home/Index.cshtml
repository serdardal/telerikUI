@{
    ViewData["Title"] = "Home Page";
}

<div id="controlBox" style="width:19%; height:500px; float:left; background-color:aqua">
    <select id="templateNames" style="width:100%; height:50%" multiple>
    </select>
    <button id="selectTemplate" onclick="handleSelectTemplate()">Select Template</button>
</div>
<button onclick="sendFilledCells()">Save</button>
<div id="spreadsheet" style="float:left; width:80%"></div>

<script>
    $("#spreadsheet").kendoSpreadsheet({
        render: function (e) {
            var height = window.innerHeight;
            e.sender.element.innerHeight(height-100);
        },
        excelExport: function (e) {
            e.workbook.fileName = "Spreadsheet1.xlsx";
        },
    });
    var spread = $('#spreadsheet').getKendoSpreadsheet();
    var cells;

    function b64toBlob(dataURI) {
	    var byteString = atob(dataURI.split(',')[1]);
	    var ab = new ArrayBuffer(byteString.length);
	    var ia = new Uint8Array(ab);

	    for (var i = 0; i < byteString.length; i++) {
		    ia[i] = byteString.charCodeAt(i);
	    }

	    return new Blob([ab], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    }

    function lockAllCells() {
        var sheetList = spread.sheets();
        for (var i = 0; i < sheetList.length; i++) {
            var sheet = sheetList[i];
            var range = sheet.range("A1:AX200");
            range.enable(false);
        }

    }

    function unlockCells(docName) {
        $.ajax({
            url: 'Home/GetUnlockedCells/' + docName,
        method: "get",
            success: function (datas) {

                cells = datas;

                var sheetList = spread.sheets();
                var sheet = sheetList[0];

                for (var i = 0; i < datas.length; i++) {
                    var range = sheet.range(datas[i].rowIndex-1, datas[i].columnIndex-1)
                    range.enable(true);
                }
            }
        })
    }

    function sendFilledCells() {
        var sheetList = spread.sheets();
        var sheet = sheetList[0];

        var filledCells = [];

        for (var i = 0; i < cells.length; i++) {
            var range = sheet.range(cells[i].rowIndex - 1, cells[i].columnIndex - 1)
            var value = range.values()[0][0];

            if (value !== null)
                filledCells.push({
                rowIndex: cells[i].rowIndex,
                columnIndex: cells[i].columnIndex,
                value: value
                })
        }

        $.ajax({
            url: '@Url.Action("WriteToExcelFile","Home")',
            method: "post",
            contentType: "application/json",
            data: JSON.stringify(filledCells)
        })
    }

    function loadTemplateNames(names) {
        names.map((name) => {
            var option = document.createElement("option");
            option.text = name;
            $('#templateNames').append(option);
        })
    }

    function handleSelectTemplate() {
        var selected = $('#templateNames option:selected').val()
        openTemplate(selected);
    }

    function openTemplate(name) {
        $.ajax({
        url: 'Home/GetTemplateByName/'+name,
        method: "get",
        success: function (data) {
            spread.fromFile(b64toBlob(data)).then(() => lockAllCells()).then(() => unlockCells(name));
        }
    })
    }

    $.ajax({
        url: '@Url.Action("GetTemplateNames", "Home")',
        method: "get",
        success: function (data) {
            loadTemplateNames(data)
        }
    })

</script>

